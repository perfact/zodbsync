#!/usr/bin/python

import sys
import inspect
import argparse

try:
    import perfact.loggingtools
except ImportError:
    pass


class SubCommand():
    ''' Base class for Sub-Commands. '''
    def register(self, subs):
        ''' Add a subparser for myself. '''
        if self.__class__ is SubCommand:
            # Only for subclasses
            return
        subparser = subs.add_parser(self.__class__.__name__.lower())
        self.add_args(subparser)
        subparser.set_defaults(runner=self.run)


class Record(SubCommand):
    ''' Sub-command to record objects from the Data.FS to the file system.
    '''
    def add_args(self, parser):
        parser.add_argument('--lasttxn', nargs='?', type=str,
                            help='Record only transactions since this '
                            'transaction (or the last used)',
                            const='last', default=None)
        parser.add_argument('--commitmsg', '-m', nargs='?', type=str,
                            help='Commit message for standard run.',
                            default=None)
        parser.add_argument('path', type=str, nargs='+',
                            help='Sub-Path in Data.fs to be recorded')

    def run(self, args):
        print(args)


class Watch(SubCommand):
    ''' Sub-command to start watcher, which periodically records changes as
    they occur.
    '''
    def add_args(self, parser):
        pass

    def run(self, args):
        print(args)


class Playback(SubCommand):
    ''' Sub-command to play back objects from the file system to the Data.fs.
    '''
    def add_args(self, parser):
        parser.add_argument(
            '--override', '-o', action='store_true',
            help='Override object type changes when uploading',
            default=False
        )
        parser.add_argument(
            '--no-recurse', action='store_true',
            help='''Only upload metadata, do not remove elements or recurse.
            Note: If a path no longer present on the file system is given, it
            is still removed.''',
            default=False
        )
        parser.add_argument(
            '--skip-errors', action='store_true',
            help="Skip failed objects and continue",
            default=False
        )

    def run(self, args):
        print(args)


class Pick(SubCommand):
    ''' Sub-command to cherry-pick commits, apply them and play back affected
    objects.
    '''
    def add_args(self, parser):
        parser.add_argument(
            'commit', type=str, nargs='+',
            help='''Commits that are checked for compatibility and applied,
            playing back all affected paths at the end.'''
        )

    def run(self, args):
        print(args)


class Apply(SubCommand):
    '''Sub-command to apply patches and play back changed files.'''

    def add_args(self, parser):
        parser.add_argument(
            'patchfile', type=str, nargs='+',
            help='''Patch files which are applied to the repository (using git
            am). If successful, the changed objects are played back. Else, the
            am session is automatically rolled back.''',
        )

    def run(self, args):
        print(args)


class Reset(SubCommand):
    ''' Sub-command to reset the current branch to the state of another branch,
    playing back any changed files.'''

    def add_args(self, parser):
        pass

    def run(self, args):
        print(args)


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='''
        Tool to sync objects between a ZODB and a git-controlled folder on the
        file system.
    ''')
    default_configfile = '/etc/perfact/modsync/zodb.py'
    parser.add_argument('--config', '-c', type=str,
                        help='Path to config (default: %s)'
                        % default_configfile,
                        default=default_configfile)
    if 'perfact.loggingtools' in sys.modules:
        perfact.loggingtools.addArgs(parser, name='ZODBSync')

    # add all available SubCommand classes as sub-command runners
    subs = parser.add_subparsers()
    for cls in list(locals().values()):
        if inspect.isclass(cls) and issubclass(cls, SubCommand):
            cls().register(subs)

    args = parser.parse_args()

    if 'perfact.loggingtools' in sys.modules:
        logger = perfact.loggingtools.createLogger(args=args, name='ZODBSync')

    args.runner(args)
